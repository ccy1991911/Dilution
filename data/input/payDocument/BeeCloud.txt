1.4 移动APP收款
1.4.1 流程概述
下图为整个支付的流程: pic

其中需要开发者开发的只有：

步骤①（在App端）发送订单信息

做完这一步之后就会跳到相应的支付页面（如微信app中），让用户继续后续的支付步骤

步骤②：（在App端）处理同步回调结果

付款完成或取消之后，会回到客户app中，在页面中展示支付结果（比如弹出框告诉用户“支付成功"或"支付失败”)。同步回调结果只作为界面展示的依据，不能作为订单的最终支付结果，最终支付结果应以异步回调为准。

步骤③：（在客户服务端）处理异步回调结果（Webhook）

付款完成之后，根据客户在BeeCloud后台的设置，BeeCloud会向客户服务端发送一个Webhook请求，里面包括了数字签名，订单号，订单金额等一系列信息。客户需要在服务端依据规则要验证数字签名是否正确，购买的产品与订单金额是否匹配，这两个验证缺一不可。验证结束后即可开始走支付完成后的逻辑。

1.4.2 在APP中使用支付宝收款
用户发起付款请求
系统生成付款订单，包括订单号，订单标题，金额等信息
将订单存入自己系统数据库中，标记订单为未支付
调用BeeCloud SDK中的支付接口，请求支付宝
调起支付宝APP，用户进行支付，支付完成后跳回商户APP
支付成功，webhook通知商户服务器，商户校验后将自己数据库中的订单标记为支付成功  iOS的支付宝有特殊参数scheme，详情查看SDK readme文件配置部分  参数bill_no(订单号)8到32位数字字母组合，并且要求全局唯一，已经提交的订单的订单号不论是否支付成功都不能重复使用  支持的渠道包括：ALI_APPBC_ALI_APP
支付宝APP支付代码示例：

1.4.3 在APP中使用微信收款
用户发起付款请求
系统生成付款订单，包括订单号，订单标题，金额等信息
将订单存入自己系统数据库中，标记订单为未支付
调用BeeCloud SDK中的支付接口，请求微信
调起微信APP，用户进行支付，支付完成后跳回商户APP
支付成功，webhook通知商户服务器，商户校验后将自己数据库中的订单标记为支付成功  参数bill_no(订单号)8到32位数字字母组合，并且要求全局唯一，已经提交的订单的订单号不论是否支付成功都不能重复使用  支持的渠道包括：WX_APP BC_WX_APP
微信APP支付代码示例：

1.4.4 在APP中使用银联收款
用户发起付款请求
系统生成付款订单，包括订单号，订单标题，金额等信息
将订单存入自己系统数据库中，标记订单为未支付
调用BeeCloud SDK中的支付接口，请求银联
调起银联插件，用户进行支付，支付完成后跳回商户APP  参数bill_no(订单号)8到32位数字字母组合，并且要求全局唯一，已经提交的订单的订单号不论是否支付成功都不能重复使用  支持的渠道包括：UN_APP BC_APP

请参考各开发语言的Webhook demo学习如何处理Webhook消息。

目的在于验证Webhook是由BeeCloud发起的，防止黑客向此Webhook接口发送伪造的订单信息。Beecloud使用MD5方式进行webhook加密，商户需要按照如下方法对参数进行数字签名验证。

商户必须按照上表中“验签内容”中罗列的参数顺序，将参数连接成字符串，然后进行MD5数字签名(32字符十六进制)。比较所得结果与signature字段值是否相等。其中master_secret为注册后从BeeCloud获取的密钥。注意，signature中的字母全部为小写。

同一条订单可能会发送多条支付成功的webhook消息，这有可能是由支付渠道本身触发的(比如渠道的重试)，也有可能是BeeCloud的Webhook重试。商户需要根据订单号进行判重，忽略已经处理过的订单号对应的Webhook。

商户需要验证Webhook中的 transaction_fee （实际的交易金额）与客户内部系统中的相应订单的金额匹配。
这个验证的目的在于防止黑客反编译了iOS或者Android app的代码，将本来比如100元的订单金额改成了1分钱，应该识别这种情况，避免误以为用户已经足额支付。Webhook传入的消息里面应该以某种形式包含此次购买的商品信息，比如title或者optional里面的某个参数说明此次购买的产品是一部iPhone手机，或者直接根据订单号查询，客户需要在内部数据库里去查询iPhone的金额是否与该Webhook的订单金额一致，仅有一致的情况下，才继续走正常的业务逻辑。如果发现不一致的情况，排除程序bug外，需要去查明原因，防止不法分子对你的app进行二次打包，对你的客户的利益构成潜在威胁。而且即使有这样极端的情况发生，只要按照前述要求做了购买的产品与订单金额的匹配性验证，客户也不会有任何经济损失。
这里就可以完成业务逻辑的处理。最后返回结果。用户返回 success 字符串给BeeCloud表示 - 正确接收并处理了本次Webhook，其他所有返回都代表需要继续重传本次的Webhook请求。

服务器端通过计算 app_id + transaction_id + transaction_type + channel_type + transaction_fee + master_secret 的MD5生成的签名(32字符十六进制),请在接受数据时自行按照此方式验证signature的正确性，不正确不返回success即可. 其中master_secret为用户创建Beecloud App时获取的参数。
服务器端通过计算 app_id + transaction_id + transaction_type + channel_type + transaction_fee + master_secret 的MD5生成的签名(32字符十六进制),请在接受数据时自行按照此方式验证signature的正确性，不正确不返回success即可. 其中master_secret为用户创建Beecloud App时获取的参数。
服务端的时间（毫秒）
WX/ALI/UN/KUAIQIAN/JD/BD/YEE/PAYPAL 分别代表微信/支付宝/银联/快钱/京东/百度/易宝/PAYPAL
代表以上各个渠道的子渠道，参看字段说明
PAY/REFUND 分别代表支付和退款的结果确认
交易单号，对应支付请求的bill_no或者退款请求的refund_no,对于秒支付button为传入的out_trade_no
实付金额，是以分为单位的整数，当不使用优惠券时对应支付请求的total_fee或者退款请求的refund_fee，使用优惠券时是total_fee减掉优惠金额的实付金额
订单金额（原始的订单金额），单位为分
优惠金额，单位为分
卡券ID，没有用到返回null
交易是否成功，目前收到的消息都是交易成功的消息
{orderId:xxx…..} 从支付渠道方获得的详细结果信息，例如支付的订单号，金额， 商品信息等，详见附录
附加参数，为一个JSON格式的Map，客户在发起购买或者退款操作时添加的附加信息

交易状态
支付宝交易号
商家内部交易号
买家支付宝账号可以是email或者手机号
商品总价，单位为元
商品单价，单位为元
订单标题
折扣
交易创建时间
通知类型
购买数量
卖家支付宝唯一用户号
买家支付宝唯一用户号
买家是否使用了红包 （N/Y)
服务器端通过计算 app_id + transaction_id + transaction_type + channel_type + transaction_fee + master_secret 的MD5生成的签名(32字符十六进制),请在接受数据时自行按照此方式验证signature的正确性，不正确不返回success即可. 其中master_secret为用户创建Beecloud App时获取的参数。
服务端的时间（毫秒）
WX/ALI/UN/KUAIQIAN/JD/BD/YEE/PAYPAL 分别代表微信/支付宝/银联/快钱/京东/百度/易宝/PAYPAL
代表以上各个渠道的子渠道，参看字段说明
PAY/REFUND 分别代表支付和退款的结果确认
交易单号，对应支付请求的bill_no或者退款请求的refund_no,对于秒支付button为传入的out_trade_no
实付金额，是以分为单位的整数，当不使用优惠券时对应支付请求的total_fee或者退款请求的refund_fee，使用优惠券时是total_fee减掉优惠金额的实付金额
订单金额（原始的订单金额），单位为分
优惠金额，单位为分
卡券ID，没有用到返回null
交易是否成功，目前收到的消息都是交易成功的消息
{orderId:xxx…..} 从支付渠道方获得的详细结果信息，例如支付的订单号，金额， 商品信息等，详见附录
附加参数，为一个JSON格式的Map，客户在发起购买或者退款操作时添加的附加信息

微信交易号
交易结束时间
商家内部交易号
商品总价，单位为分
现金付款额
买家的openid
通信标示
业务结果
BeeCloud平台的AppID
签名生成时间
加密签名
渠道类型
订单总金额
商户订单号
订单标题
附加数据
分析数据
同步返回页面
商户自定义回调地址
订单失效时间
银行卡号
禁用信用卡
银行名字
卡类型
门店号
商家id
卡券id
消费者ID
禁用渠道，用户不可用指定渠道支付,当有多个渠道时用“,”分隔,例如pcredit,moneyFund,debitCardExpress
BeeCloud平台的AppID
签名生成时间
加密签名
渠道类型
订单总金额
商户订单号
订单标题
附加数据
分析数据
同步返回页面
商户自定义回调地址
订单失效时间
银行卡号
禁用信用卡
银行名字
卡类型
门店号
商家id
卡券id
消费者ID
禁用渠道，用户不可用指定渠道支付,当有多个渠道时用“,”分隔,例如pcredit,moneyFund,debitCardExpress
返回码，0为正常
返回信息， OK为正常
具体错误信息
成功发起支付后返回支付表记录唯一标识
支付宝签名串
返回码，0为正常
返回信息， OK为正常
具体错误信息
成功发起支付后返回支付表记录唯一标识
支付宝签名串
BeeCloud平台的AppID
签名生成时间
加密签名
渠道类型
订单总金额
商户订单号
订单标题
附加数据
分析数据
同步返回页面
商户自定义回调地址
订单失效时间
银行卡号
禁用信用卡
银行名字
卡类型
门店号
商家id
卡券id
消费者ID
自定义参数
返回码，0为正常
返回信息， OK为正常
具体错误信息
成功发起支付后返回支付表记录唯一标识
微信应用APPID
微信支付商户号
微信支付打包参数
随机字符串
当前时间戳，单位是毫秒，13位
签名值
微信预支付id
一、企业认证
未注册的用户需先注册
已注册用户直接登录
登陆后,进入企业认证 , 提交材料进行企业认证
工作时间审核周期3小时以内, 非工作时间审核周期24小时以内, 需要加急请与我们联系我们
BeeCloud暂不对个人用户服务

二、配置支付参数
进入 控制台 ,创建一个新应用
如果没有支付账号, 可使用代申请服务, 点击每个应用的"代申请"按钮即可进入, 申请材料准备参见 支付资质申请指南
如果已有支付账号, 请将支付参数配置到相应应用的"设置"内. 详情请参考 渠道申请及参数配置帮助

企业五证：营业执照、税务登记证、组织机构代码证、银行开户许可证、法人身份证

三证合一：营业执照、税务登记证、组织机构代码证合并为一张证书，在营业执照上显示为统一社会信用代码。

微信支付：提供APP Store或应用宝等应用商店页面地址，头部要包含http或https 例如http://itunes.apple.com/cn/app/wei/id414478124，请勿直接填写安装包的下载地址；若APP尚未上线，可提供APP页面截图。
APP页面截图应该包含：APP首页、APP版权信息页、APP商品展示页、APP支付方式页。

支付宝：应用程序的说明文件，必须包含APP的图片以及相关说明。

支付宝支付

查看支付宝官方申请流程
一、注册：在支付宝商家服务注册支付宝个人账号或者企业账号
个人账号可以签约支付宝线下支付产品，包括条码支付、扫码支付、声波支付。
企业账号可以签约支付宝即时到帐(PC网页)、手机移动网页、移动支付、线下支付产品、批量打款产品。

二、完善资料
注册完成后，登录到支付宝商家服务，选择我的商家服务，完善资料。

三、实名认证
完成实名认证后才能签约支付宝产品。

四、签约产品
支付宝即时到账(PC网页)
支付宝手机网站支付
支付宝移动支付(APP支付)
支付宝线下支付
支付宝线下支付只需要签约条码支付、扫码支付、声波支付其中的一种即可。

微信APP支付

查看微信APP支付申请流程
一、注册微信开放平台
注册成为微信开放平台开发者

二、认证开发者资质
开发者资质认证通过后才可申请微信支付，微信官方收取申请审核服务费：300元/次。

三、创建APP并提交审核
提交你的APP基本信息，通过开放平台应用审核，以获得AppID。

四、开通微信支付
在APP的详情中开通微信支付功能(查看申请帮助)。

申请所需材料
联系方式：商户联系人、联系电话、联系邮箱
经营信息：商品简介、商户简称、售卖商品类目、售卖资质证件(查看支持类目及对应资质证件)
结算信息：结算银行信息、结算银行卡号
温馨提醒：营业执照、法人身份证等信息将从您微信认证资料中获取，您可核对信息正确后，直接提交。如果认证信息已过期或需修改，您可修改后提交。

微信公众号支付

微信公众号的微信支付功能包含以下三种场景：
公众号支付
在微信内的商家页面上完成支付
扫码支付
扫描二维码(包含PC网页)进行支付
刷卡支付
用户展示条码，商户扫描后，完成支付

一、注册微信公众号
注册微信公众号(服务号类型)
请根据营业执照类型选择以下接入方式：
个体工商户 | 企业/公司 | 政府 | 媒体 | 其他组织

二、申请微信认证
服务号认证后才可申请微信支付，微信官方收取申请审核服务费：300元/次。
如何认证

三、提交资料申请微信支付
资料审核时间为3~7个工作日
申请帮助 | 申请所需材料

银联在线支付

一、准备资料
基本资料：企业五证联系人姓名联系人电话
银联网页支付还需要：备案网站ICP备案号
银联APP支付提交基本资料即可

二、提交申请
准备好资料后，在BeeCloud代申请页面填写资料，提交代申请订单。

渠道申请及参数配置帮助


微信APP支付（BeeCloud配置参数）
一、在控制台配置微信支付要素
1、申请通过后，在开户邮件中可获得微信商户号、应用APPID;
2、使用开户邮件中提供的商户平台登录账号、商户平台登录密码登录到微信支付商户平台。
3、在【账户设置->API安全】菜单下设置微信支付API密钥以及下载微信API证书，证书密码默认为商户号（如下图）。
4、将上述支付要素填写到BeeCloud后台。
